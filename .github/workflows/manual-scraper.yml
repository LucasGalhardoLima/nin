name: Manual Scraper Trigger

on:
  workflow_dispatch:
    inputs:
      source:
        description: 'Scraper Source'
        required: true
        default: 'cardinali'
        type: choice
        options:
          - cardinali
          - chavesnamao
          - thiagofavaro
      cities:
        description: 'Target Cities (comma separated)'
        required: true
        default: 'araraquara,matao'
        type: string
  schedule:
    - cron: '0 7 * * *'

jobs:
  trigger-scraper:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: scraper-${{ inputs.source }}
      cancel-in-progress: false
    env:
      SOURCE: ${{ inputs.source || 'cardinali' }}
      CITIES: ${{ inputs.cities || 'araraquara,matao' }}
    steps:
      - name: Trigger Scraper API
        run: |
          set -euo pipefail
          echo "Triggering scraper for source: ${SOURCE}"
          
          # Convert comma separated string to JSON array string for the request body
          CITIES_JSON=$(echo "${CITIES}" | jq -R 'split(",") | map(gsub("^\\s+|\\s+$";"")) | map(select(length > 0))')
          echo "Target cities: ${CITIES_JSON}"
          
          curl --retry 3 --retry-delay 5 --retry-all-errors \
            --connect-timeout 10 --max-time 120 \
            -X POST "${{ secrets.RAILWAY_URL }}/admin/scraper/run/${SOURCE}" \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.SCRAPER_API_KEY }}" \
            -d "{\"cities\": $CITIES_JSON}" \
            --fail-with-body
